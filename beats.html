<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>BeatGrid â€” Upgraded Step Sequencer</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<style>
  body {
    font-family: sans-serif;
    background: #111;
    color: #eee;
    text-align: center;
    margin: 0;
    padding: 0;
  }
  #controls {
    margin: 10px;
  }
  table {
    margin: auto;
    border-collapse: collapse;
  }
  td {
    width: 28px; height: 28px;
    border: 1px solid #333;
    cursor: pointer;
    background: #222;
  }
  td.active { background: #0f0; }
  td.accent { background: #6f6; }
  td.highlight { outline: 2px solid #fff; }
  button, input[type=range] {
    margin: 5px;
  }
</style>
</head>
<body>
<h1>BeatGrid</h1>
<div id="controls">
  <button id="playBtn">Play</button>
  <label>BPM: <input id="bpm" type="range" min="60" max="180" value="120">
    <span id="bpmVal">120</span></label>
</div>
<div id="grid"></div>

<script>
let ctx;
let isPlaying = false;
let bpm = 120;
let stepsPerBar = 16;
let tracks = 4; // kick, snare, hat, perc
let grid = Array.from({length: tracks}, () => Array(stepsPerBar).fill(0));

let lookaheadMs = 20;           // check every 20ms
let scheduleAheadTime = 0.15;   // schedule 150ms ahead
let schedulerID = null;
let nextStepIndex = 0;
let nextNoteTime = 0;

function ensureAudio(){
  if(!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
  if(ctx.state === 'suspended'){
    return ctx.resume().then(()=>true);
  }
  return Promise.resolve(true);
}

function buildGrid(){
  const tbl = document.createElement('table');
  for(let r=0;r<tracks;r++){
    const tr = document.createElement('tr');
    for(let c=0;c<stepsPerBar;c++){
      const td = document.createElement('td');
      td.dataset.row = r;
      td.dataset.col = c;
      td.addEventListener('click', ()=>{
        grid[r][c] = (grid[r][c] + 1) % 3; // 0=off,1=normal,2=accent
        renderGrid();
      });
      tr.appendChild(td);
    }
    tbl.appendChild(tr);
  }
  document.getElementById('grid').innerHTML = '';
  document.getElementById('grid').appendChild(tbl);
}

function renderGrid(highlightColIndex){
  document.querySelectorAll('td').forEach(td=>{
    const r = +td.dataset.row, c = +td.dataset.col;
    td.className = '';
    if(grid[r][c] === 1) td.classList.add('active');
    if(grid[r][c] === 2) td.classList.add('accent');
    if(c === highlightColIndex) td.classList.add('highlight');
  });
}

function highlightCol(c){
  renderGrid(c);
}

function stepDurationSec(){
  return 60 / bpm / 4; // 16th note
}

function playSoundAt(freq, when){
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.frequency.value = freq;
  gain.gain.setValueAtTime(0.22, when);
  gain.gain.exponentialRampToValueAtTime(0.0001, when + 0.12);
  osc.connect(gain).connect(ctx.destination);
  osc.start(when);
  osc.stop(when + 0.15);
}

function scheduleStep(step, when){
  setTimeout(()=>highlightCol(step), Math.max(0,(when - ctx.currentTime)*1000));
  // Kick
  if(grid[0][step]>0) playSoundAt(100, when);
  // Snare
  if(grid[1][step]>0) playSoundAt(200, when);
  // Hat
  if(grid[2][step]>0) playSoundAt(400, when);
  // Perc
  if(grid[3][step]>0) playSoundAt(300, when);
}

function advanceStep(){
  nextNoteTime += stepDurationSec();
  nextStepIndex = (nextStepIndex + 1) % stepsPerBar;
}

function scheduler(){
  while(nextNoteTime < ctx.currentTime + scheduleAheadTime){
    scheduleStep(nextStepIndex, nextNoteTime);
    advanceStep();
  }
}

async function start(){
  if(isPlaying) return;
  const ok = await ensureAudio();
  if(!ok) return;
  isPlaying = true;
  nextStepIndex = nextStepIndex % stepsPerBar;
  nextNoteTime = ctx.currentTime + 0.05;
  schedulerID = setInterval(scheduler, lookaheadMs);
}

function stop(){
  isPlaying = false;
  clearInterval(schedulerID);
  schedulerID = null;
  renderGrid();
}

document.getElementById('playBtn').addEventListener('click', ()=>{
  if(isPlaying){ stop(); document.getElementById('playBtn').textContent='Play'; }
  else { start(); document.getElementById('playBtn').textContent='Stop'; }
});

document.getElementById('bpm').addEventListener('input', e=>{
  bpm = +e.target.value;
  document.getElementById('bpmVal').textContent = bpm;
});

buildGrid();
renderGrid();
</script>
</body>
</html>
