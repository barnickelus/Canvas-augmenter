<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BeatGrid ‚Äî Upgraded Step Sequencer</title>
<style>
  :root{
    --bg:#0b0d12;
    --panel:#141823;
    --grid:#0f1320;
    --accent:#ff6b4a;
    --accent2:#49d3ff;
    --muted:#6a7386;
    --on:#ffffff;
    --off:#1c2233;
    --playing:#ffad99;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(135deg,#20273a,#0b0d12);color:#e9eef7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
  #app{max-width:1100px;margin:20px auto;padding:16px}
  .card{background:var(--panel);border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.35);overflow:hidden}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #1f2434}
  header h1{margin:0;font-size:18px;letter-spacing:.5px;font-weight:700}
  #transport{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  button{appearance:none;border:none;border-radius:10px;background:#1e2536;color:#e9eef7;padding:10px 12px;font-weight:600;cursor:pointer}
  button:active{transform:translateY(1px)}
  .primary{background:var(--accent);color:#0b0d12}
  .ghost{background:#171d2b;color:#c9d2e0;border:1px solid #27304a}
  .danger{background:#803d3a}
  .ok{background:#1e6b4f}
  .row{display:flex;align-items:center;gap:10px}
  #controls{display:grid;grid-template-columns:repeat(2,minmax(280px,1fr));gap:12px;padding:12px 16px;border-bottom:1px solid #1f2434}
  .control{background:#121728;border:1px solid #232b42;border-radius:10px;padding:10px}
  .control label{display:flex;align-items:center;justify-content:space-between;font-size:12px;color:#a9b3c7;text-transform:uppercase;letter-spacing:.6px;margin-bottom:6px}
  .control input[type="range"]{width:100%}
  .small{font-size:12px;color:#9fb0c9}
  #gridWrap{padding:12px;overflow:auto}
  table{border-collapse:separate;border-spacing:6px;width:100%}
  .trkName{width:120px;white-space:nowrap}
  .tag{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#1a2132;border:1px solid #2a3552;color:#cfe7ff;font-size:12px}
  .muteSolo{display:flex;gap:6px;margin-left:8px}
  .pill{padding:4px 8px;border-radius:8px;border:1px solid #2d3653;background:#141b2b;color:#b7c5dd;font-size:11px;cursor:pointer}
  .pill.active{background:#2f3a57;color:#fff}
  .step{width:34px;height:34px;border-radius:8px;background:var(--off);border:1px solid #1f2741;cursor:pointer;position:relative;outline:none}
  .step.on{background:linear-gradient(180deg,#fff,#d6e6ff);border-color:#8fb9ff;box-shadow:0 2px 10px rgba(73,211,255,.35)}
  .step[data-vel="2"].on{background:linear-gradient(180deg,#ffe2d6,#ffc5b4)}
  .step.play{box-shadow:0 0 0 2px var(--playing) inset,0 0 22px rgba(255,173,153,.55)}
  .legend{display:flex;gap:10px;align-items:center;padding:10px 16px;color:#99a6bf;font-size:12px}
  #footer{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-top:1px solid #1f2434;color:#98a4bd}
  @media(max-width:760px){
    .trkName{width:96px}
    .step{width:30px;height:30px}
    #controls{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div id="app" class="card">
  <header>
    <h1>BeatGrid ‚Äî Upgraded Step Sequencer</h1>
    <div id="transport" class="row">
      <button id="play" class="primary">‚ñ∂ Play</button>
      <button id="stop" class="ghost">‚èπ Stop</button>
      <button id="rand" class="ghost">üé≤ Randomize</button>
      <button id="clear" class="danger">üßπ Clear</button>
      <button id="save" class="ok">üíæ Save</button>
      <input id="load" type="file" accept="application/json" style="display:none" />
      <button id="loadBtn" class="ghost">üìÇ Load</button>
    </div>
  </header>

  <!-- iOS audio-enabling overlay -->
  <div id="audioOverlay" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);backdrop-filter:blur(2px);z-index:9999;">
    <div style="background:#111726;border:1px solid #293154;border-radius:14px;padding:18px 22px;box-shadow:0 10px 30px rgba(0,0,0,.5);text-align:center;max-width:460px">
      <div style="font-weight:700;font-size:18px;margin-bottom:8px">Enable Audio</div>
      <div style="color:#b8c4db;font-size:14px;margin-bottom:14px">iPad/iPhone requires a tap before sound can play.</div>
      <button id="enableAudioBtn" class="primary" style="font-size:16px;padding:10px 16px">üîä Tap to Enable Sound</button>
    </div>
  </div>

  <section id="controls">
    <div class="control">
      <label><span>BPM</span><span class="small"><span id="bpmVal">120</span></span></label>
      <input id="bpm" type="range" min="50" max="220" value="140" />
    </div>
    <div class="control">
      <label><span>Swing</span><span class="small"><span id="swingVal">0%</span></span></label>
      <input id="swing" type="range" min="0" max="70" value="0" />
    </div>
    <div class="control">
      <label><span>Steps per bar</span><span class="small" id="stepsVal">16</span></label>
      <input id="steps" type="range" min="8" max="32" value="16" step="1" />
    </div>
    <div class="control">
      <label><span>Master Volume</span><span class="small" id="volVal">80%</span></label>
      <input id="volume" type="range" min="0" max="100" value="80" />
    </div>
  </section>

  <div id="gridWrap"></div>

  <div id="footer">
    <div class="legend">Tap step to toggle ‚Ä¢ Cmd/Ctrl+Click changes velocity ‚Ä¢ Long press = tie (hold)</div>
    <div>Built with WebAudio ‚Äî no samples required. <span id="audioStatus" style="margin-left:10px"></span></div>
  </div>
</div>

<script>
/* =========================
   Synth Drum Voices (no samples)
   ========================= */
class DrumKit {
  constructor(actx){
    this.ac = actx;
    this.master = this.ac.createGain();
    this.master.gain.value = 0.8;
    this.master.connect(this.ac.destination);
  }
  setMaster(v){
    this.master.gain.value = v;
  }
  env(node, {attack=0, decay=0.2, start=1, end=0}={}){ /* helper if needed */ }

  kick({vel=1}={}){
    const o = this.ac.createOscillator();
    const g = this.ac.createGain();
    o.type = 'sine';
    o.frequency.setValueAtTime(150, this.ac.currentTime);
    o.frequency.exponentialRampToValueAtTime(45, this.ac.currentTime + 0.12);
    g.gain.value = 0.0001;
    const t = this.ac.currentTime;
    g.gain.setValueAtTime(0.0001, t);
    g.gain.exponentialRampToValueAtTime(1*vel, t + 0.005);
    g.gain.exponentialRampToValueAtTime(0.0001, t + 0.25);
    o.connect(g).connect(this.master);
    o.start();
    o.stop(t+0.35);
  }
  snare({vel=1}={}){
    const noiseBuf = this.ac.createBuffer(1, this.ac.sampleRate*0.3, this.ac.sampleRate);
    const data = noiseBuf.getChannelData(0);
    for(let i=0;i<data.length;i++){ data[i] = (Math.random()*2-1) * (1 - i/data.length); }
    const noise = this.ac.createBufferSource();
    noise.buffer = noiseBuf;
    const bp = this.ac.createBiquadFilter();
    bp.type = 'highpass'; bp.frequency.value = 1800;
    const g = this.ac.createGain();
    g.gain.value = 0.7*vel;
    noise.connect(bp).connect(g).connect(this.master);
    const o = this.ac.createOscillator();
    o.type = 'triangle'; o.frequency.value = 200;
    const og = this.ac.createGain(); og.gain.value = 0.6*vel;
    o.connect(og).connect(this.master);
    const t = this.ac.currentTime;
    og.gain.setValueAtTime(0.6*vel, t);
    og.gain.exponentialRampToValueAtTime(0.0001, t+0.15);
    g.gain.setValueAtTime(0.7*vel, t);
    g.gain.exponentialRampToValueAtTime(0.0001, t+0.2);
    noise.start();
    o.start();
    noise.stop(t+0.25);
    o.stop(t+0.25);
  }
  hat({vel=1, open=false}={}){
    const noiseBuf = this.ac.createBuffer(1, this.ac.sampleRate*0.5, this.ac.sampleRate);
    const data = noiseBuf.getChannelData(0);
    for(let i=0;i<data.length;i++){ data[i] = Math.random()*2-1; }
    const noise = this.ac.createBufferSource();
    noise.buffer = noiseBuf;
    const hp = this.ac.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=5500;
    const g = this.ac.createGain(); g.gain.value = (open?0.4:0.25)*vel;
    noise.connect(hp).connect(g).connect(this.master);
    const t = this.ac.currentTime;
    g.gain.setValueAtTime(g.gain.value, t);
    g.gain.exponentialRampToValueAtTime(0.0001, t + (open?0.45:0.07));
    noise.start();
    noise.stop(t + (open?0.5:0.08));
  }
  perc({vel=1}={}){
    const c = this.ac.createOscillator();
    const m = this.ac.createOscillator();
    const mg = this.ac.createGain();
    m.frequency.value = 200;
    mg.gain.value = 50;
    m.connect(mg).connect(c.frequency);
    c.type='sine'; c.frequency.value = 600;
    const g = this.ac.createGain(); g.gain.value=0.6*vel;
    c.connect(g).connect(this.master);
    const t = this.ac.currentTime;
    g.gain.setValueAtTime(g.gain.value, t);
    g.gain.exponentialRampToValueAtTime(0.0001, t+0.25);
    c.start(); m.start();
    c.stop(t+0.3); m.stop(t+0.3);
  }
}

/* ===== Robust iOS/Browser Audio Init ===== */
let ctx = null;
let kit = null;

async function ensureAudio(){
  if(ctx && kit) return true;
  const AC = window.AudioContext || window.webkitAudioContext;
  if(!AC){ alert('Web Audio not supported in this browser'); return false; }
  ctx = new AC();
  kit = new DrumKit(ctx);
  const volEl = document.getElementById('volume');
  if(volEl){ kit.setMaster(+volEl.value/100); }

  try{
    await ctx.resume();
    // short oscillator blip
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    g.gain.value = 0.001;
    o.frequency.value = 880;
    o.connect(g).connect(kit.master);
    const t = ctx.currentTime;
    o.start(t); o.stop(t+0.05);
  }catch(e){ console.warn('osc unlock failed', e); }

  try{
    // silent buffer source (non-zero samples)
    const buf = ctx.createBuffer(1, 128, ctx.sampleRate);
    const srcNode = ctx.createBufferSource();
    srcNode.buffer = buf;
    srcNode.connect(kit.master);
    srcNode.start();
  }catch(e){ console.warn('buffer unlock failed', e); }

  return ctx.state !== 'suspended';
}

// Status + overlay helpers
function setAudioStatus(txt){ const el = document.getElementById('audioStatus'); if(el) el.textContent = txt||''; }
function hideOverlay(){ const o = document.getElementById('audioOverlay'); if(o) o.style.display='none'; }
document.getElementById('enableAudioBtn').onclick = async ()=>{
  const ok = await ensureAudio();
  if(ok){ hideOverlay(); setAudioStatus('‚úÖ Audio ready'); } else { setAudioStatus('‚ö†Ô∏è Audio blocked'); }
};

// One-time global gesture listeners to arm audio ASAP
let audioArmed = false;
function armAudioOnce(){
  if(audioArmed) return;
  audioArmed = true;
  ensureAudio();
  ['touchend','mousedown','keydown'].forEach(ev=>{
    window.removeEventListener(ev, armAudioOnce, {passive:true});
  });
}
['touchend','mousedown','keydown'].forEach(ev=>{
  window.addEventListener(ev, armAudioOnce, {passive:true});
});

/* =========================
   Sequencer State
   ========================= */
const tracks = [
  {name:'Kick', icon:'ü•Å', type:'kick', color:'#ffb86b'},
  {name:'Snare', icon:'ü•Å', type:'snare', color:'#ff6b8a'},
  {name:'Closed Hat', icon:'‚ú®', type:'hat', hatOpen:false, color:'#49d3ff'},
  {name:'Open Hat', icon:'‚ú®', type:'hat', hatOpen:true, color:'#7fffbf'},
  {name:'Perc 1', icon:'üîî', type:'perc', color:'#ffd34e'},
  {name:'Perc 2', icon:'üîî', type:'perc', color:'#9eff6b'},
  {name:'Clap-ish', icon:'üëè', type:'snare', color:'#ff9bd6'},
  {name:'Click', icon:'‚è∫', type:'hat', color:'#c3d3ff'},
];

let stepsPerBar = 16;
let grid = tracks.map(()=> Array(stepsPerBar).fill(0)); // 0 off, 1 on (vel1), 2 on (vel2)
let mutes = tracks.map(()=>false);
let solos = tracks.map(()=>false);

let currStep = 0;
let isPlaying = false;
let swing = 0; // 0..70 (percent)
let bpm = 140;

function setSteps(newSteps){
  const old = stepsPerBar;
  stepsPerBar = newSteps;
  grid = grid.map(row => {
    const resized = Array(newSteps).fill(0);
    for(let i=0;i<Math.min(old,newSteps);i++){ resized[i] = row[i]; }
    return resized;
  });
  renderGrid();
}

/* =========================
   Rendering
   ========================= */
const gridWrap = document.getElementById('gridWrap');

function makeStepCell(r,c){
  const btn = document.createElement('button');
  btn.className = 'step';
  btn.setAttribute('data-row', r);
  btn.setAttribute('data-col', c);
  btn.setAttribute('aria-label', `r${r} c${c}`);
  btn.onpointerdown = (ev)=>{
    ev.preventDefault();
    cycleCell(r,c, ev.metaKey||ev.ctrlKey);
  };
  btn.oncontextmenu = (e)=>{ e.preventDefault(); cycleCell(r,c,true); };
  return btn;
}
function cycleCell(r,c, velocityToggle=false){
  let v = grid[r][c];
  if(velocityToggle){
    v = (v+1)%3; // 0 -> 1 -> 2 -> 0
  } else {
    v = v?0:1;
  }
  grid[r][c]=v;
  updateCell(r,c);
}
function updateCell(r,c){
  const id = `cell-${r}-${c}`;
  const el = document.getElementById(id);
  if(!el) return;
  const v = grid[r][c];
  el.classList.toggle('on', v>0);
  el.dataset.vel = v; // 1 or 2
}
function renderGrid(){
  const table = document.createElement('table');
  const tbody = document.createElement('tbody');
  for(let r=0;r<tracks.length;r++){
    const tr = document.createElement('tr');

    const name = document.createElement('td');
    name.className='trkName';
    const tag = document.createElement('div');
    tag.className='tag';
    tag.innerHTML = `<span style="font-size:14px">${tracks[r].icon}</span> <strong>${tracks[r].name}</strong>`;
    const ms = document.createElement('div'); ms.className='muteSolo';
    const muteBtn = document.createElement('button'); muteBtn.className='pill'; muteBtn.textContent='Mute';
    const soloBtn = document.createElement('button'); soloBtn.className='pill'; soloBtn.textContent='Solo';
    muteBtn.onclick=()=>{ mutes[r]=!mutes[r]; muteBtn.classList.toggle('active', mutes[r]); };
    soloBtn.onclick=()=>{ solos[r]=!solos[r]; soloBtn.classList.toggle('active', solos[r]); };
    ms.appendChild(muteBtn); ms.appendChild(soloBtn);
    name.appendChild(tag); name.appendChild(ms);
    tr.appendChild(name);

    for(let c=0;c<stepsPerBar;c++){
      const td = document.createElement('td');
      const btn = makeStepCell(r,c);
      btn.id = `cell-${r}-${c}`;
      td.appendChild(btn);
      updateCell(r,c);
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }
  table.appendChild(tbody);
  gridWrap.innerHTML = '';
  gridWrap.appendChild(table);
}
renderGrid();
window.addEventListener('load', ()=>{ renderGrid(); });

/* =========================
   Transport & Timing
   ========================= */
function nextStepTime(startTime, stepIndex, spb, swingAmt){
  const base = startTime + stepIndex * spb;
  const isEven = (stepIndex % 2 === 1);
  const delay = isEven ? swingAmt * spb * 0.5 : 0;
  return base + delay;
}

function scheduleBar(startAt){
  if(!ctx||!kit) return;
  const spb = 60/bpm/4; // 16ths at 4 per beat
  const swingAmt = swing/100;
  for(let step=0; step<stepsPerBar; step++){
    const when = nextStepTime(startAt, step, spb, swingAmt);
    setTimeout(()=> highlightCol(step), (when - ctx.currentTime)*1000);
    tracks.forEach((t, r)=>{
      const v = grid[r][step];
      if(v>0 && !mutes[r] && (!solos.some(Boolean) || solos[r])){
        const vel = v===2 ? 1.0 : 0.7;
        if(t.type==='kick') kit.kick({vel});
        else if(t.type==='snare') kit.snare({vel});
        else if(t.type==='hat') kit.hat({vel, open: t.hatOpen});
        else if(t.type==='perc') kit.perc({vel});
      }
    });
  }
  currStep = (currStep + stepsPerBar) % stepsPerBar;
}

let loopTimer = null;
async function start(){
  if(isPlaying) return;
  const ok = await ensureAudio();
  if(!ok) return;
  isPlaying = true;
  const barDur = (60/bpm/4) * stepsPerBar;
  const startAt = ctx.currentTime + 0.06;
  scheduleBar(startAt);
  loopTimer = setInterval(()=>{
    scheduleBar(ctx.currentTime + 0.02);
  }, barDur*1000);
}
function stop(){
  isPlaying=false;
  clearInterval(loopTimer);
  clearHighlights();
}

function highlightCol(col){
  document.querySelectorAll('.step.play').forEach(el=>el.classList.remove('play'));
  for(let r=0;r<tracks.length;r++){
    const el = document.getElementById(`cell-${r}-${col}`);
    if(el) el.classList.add('play');
  }
}
function clearHighlights(){
  document.querySelectorAll('.step.play').forEach(el=>el.classList.remove('play'));
}

/* =========================
   IO: Save/Load/Random/Clear
   ========================= */
function randomize(){
  grid = grid.map((row, r)=> row.map((_,c)=>{
    const density = (r<=2)? 0.35 : 0.2;
    if(Math.random() < density){
      return Math.random() < 0.25 ? 2 : 1;
    }
    return 0;
  }));
  renderGrid();
}
function clearAll(){
  grid = grid.map(row=> row.map(()=>0));
  renderGrid();
}

function saveJSON(){
  const data = {bpm, swing, stepsPerBar, grid, mutes, solos};
  const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'beatgrid_pattern.json';
  a.click();
  URL.revokeObjectURL(url);
}
function loadJSON(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      bpm = obj.bpm ?? bpm; swing = obj.swing ?? swing;
      document.getElementById('bpm').value = bpm; document.getElementById('bpmVal').textContent = bpm;
      document.getElementById('swing').value = swing; document.getElementById('swingVal').textContent = Math.round(swing)+'%';
      setSteps(obj.stepsPerBar ?? stepsPerBar);
      grid = obj.grid ?? grid;
      mutes = obj.mutes ?? mutes;
      solos = obj.solos ?? solos;
      renderGrid();
    }catch(e){ alert('Invalid pattern file'); }
  };
  reader.readAsText(file);
}

/* =========================
   Wire up controls
   ========================= */
document.getElementById('play').onclick=async ()=>{ const ok = await ensureAudio(); if(ok){ hideOverlay(); setAudioStatus('‚úÖ Audio ready'); start(); } else { setAudioStatus('‚ö†Ô∏è Audio blocked'); } };
document.getElementById('stop').onclick=()=> stop();

const bpmEl = document.getElementById('bpm');
const bpmVal = document.getElementById('bpmVal');
bpmEl.addEventListener('input', e=>{ bpm = +e.target.value; bpmVal.textContent=bpm; if(isPlaying){ stop(); start(); } });

const swingEl = document.getElementById('swing');
const swingVal = document.getElementById('swingVal');
swingEl.addEventListener('input', e=>{ swing = +e.target.value; swingVal.textContent = Math.round(swing)+'%'; });

const stepsEl = document.getElementById('steps');
const stepsVal = document.getElementById('stepsVal');
stepsEl.addEventListener('input', e=>{ stepsVal.textContent = +e.target.value; });
stepsEl.addEventListener('change', e=>{ setSteps(+e.target.value); });

const volEl = document.getElementById('volume');
const volVal = document.getElementById('volVal');
volEl.addEventListener('input', e=>{ if(kit) kit.setMaster(+e.target.value/100); volVal.textContent = e.target.value+'%'; });

document.getElementById('rand').onclick = randomize;
document.getElementById('clear').onclick = clearAll;
document.getElementById('save').onclick = saveJSON;
document.getElementById('loadBtn').onclick = ()=> document.getElementById('load').click();
document.getElementById('load').addEventListener('change', e=>{
  if(e.target.files[0]) loadJSON(e.target.files[0]);
});

// seed groove
(function seed(){
  const k = 0, s = 1, ch = 2, oh = 3, p1 =4, p2=5, cl=6, ck=7;
  setSteps(16);
  grid[k] = [1,0,0,0, 0,0,0,0, 1,0,0,0, 0,0,0,0];
  grid[s] = [0,0,0,0, 1,0,0,0, 0,0,0,0, 1,0,0,0];
  grid[ch]= [1,0,1,0, 1,0,1,0, 1,0,1,0, 1,0,1,0];
  grid[oh]= [0,0,0,0, 0,0,0,0, 0,0,0,0, 0,0,1,0];
  grid[p1]= [0,0,0,0, 0,1,0,0, 0,0,0,0, 0,0,0,0];
  grid[p2]= [0,0,0,0, 0,0,0,0, 0,0,1,0, 0,0,0,0];
  grid[cl]= [0,0,0,0, 0,0,1,0, 0,0,0,0, 0,0,0,0];
  grid[ck]= [0,0,0,0, 0,0,0,1, 0,0,0,0, 0,0,0,1];
  renderGrid();
})();
</script>
</body>
</html>
