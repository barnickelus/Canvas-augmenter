<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Mural Maker â€” Linked AR</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- libraries -->
  <script src="https://unpkg.com/peerjs@1.5.5/dist/peerjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.5.0/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.4/dist/mindar-image-aframe.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/fcor/arjs-gestures/dist/gestures.min.js"></script>

  <style>
    html,body{margin:0;height:100%;overflow:hidden;background:#000;font:16px Arial}
    #ui{position:fixed;top:10px;left:10px;z-index:10;color:#fff;
        backdrop-filter:blur(4px);padding:6px 10px;border-radius:8px}
    #ui select,#ui input{font:inherit}
    video{display:none}
  </style>
</head>
<body>

<!--â€Šcontrol panelâ€Š-->
<div id="ui">
  Role :
  <select id="role">
    <option value="camera">Tripod Camera</option>
    <option value="viewer">Painter Viewer</option>
  </select>
  Peer ID <input id="pid" placeholder="(auto)" disabled>
  <button id="go">Start</button>
  <button id="pickBtn" style="display:none">ðŸ“· Choose Image</button>
  <input id="filePick" type="file" accept="image/*" hidden>
</div>

<!--â€Šhidden video elementsâ€Š-->
<video id="cam" playsinline muted></video>
<video id="remote" playsinline muted></video>

<!--â€ŠAR sceneâ€Š-->
<a-scene id="scene" embedded style="display:none"
         gesture-detector
         device-orientation-permission-ui="enabled: true">
  <a-assets>
    <video id="camTex" autoplay playsinline muted></video>
  </a-assets>

  <!--â€‰live backgroundâ€‰-->
  <a-plane id="bg" width="4" height="3" position="0 0 -4"
           material="shader: flat; src: #camTex"></a-plane>

  <!--â€‰mural overlay anchored to markerâ€‰-->
  <a-entity mindar-image="imageTargetSrc: targets.mind;">
    <a-plane id="mural" src="mural.jpg" width="1.8" height="1.2"
             gesture-handler></a-plane>
  </a-entity>

  <a-entity camera></a-entity>
</a-scene>

<script>
const $ = sel => document.querySelector(sel);
let peer;

/*â€Šinitial clickâ€Š*/
$('#go').onclick = () => {
  peer = new Peer();                                 // uses PeerJS Cloud
  const role = $('#role').value;

  peer.on('open', id => {
    if (role === 'camera') {
      $('#pid').value = id;
      startCameraMode();
    } else {
      $('#pickBtn').style.display = 'inline-block';
      $('#pid').placeholder = 'enter camera ID';
      $('#pid').disabled = false;
      $('#go').textContent = 'Connect';
      $('#go').onclick = () => startViewerMode($('#pid').value);
    }
  });
};

/*â€ŠTripod Cameraâ€Š*/
async function startCameraMode() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: 'environment' }, audio: false });
  $('#cam').srcObject = stream; $('#cam').play();
  $('#ui').innerHTML =
    `Tripod camera ready.<br>ID: <b>${$('#pid').value}</b><br>(share this ID)`;

  peer.on('call', call => call.answer(stream));     // serve stream to viewers
}

/*â€ŠPainter Viewerâ€Š*/
function startViewerMode(camID) {
  if (!camID) { alert('Enter the camera peer-ID'); return; }

  $('#scene').style.display = 'block';
  $('#ui').style.display = 'none';

  const call = peer.call(camID, null);
  call.on('stream', stream => {
    $('#remote').srcObject = stream; $('#remote').play();
    $('#camTex').srcObject = stream;                // texture for background
  });

  /*â€Šimage pickerâ€Š*/
  $('#pickBtn').onclick = () => $('#filePick').click();
  $('#filePick').onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    $('#mural').setAttribute('src', url);           // swap mural texture
  };
}
</script>
</body>
</html>
